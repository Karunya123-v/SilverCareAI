import { useState, useEffect, useRef } from 'react';
import { ConversationBubble } from './components/ConversationBubble';
import { ResponseButtons } from './components/ResponseButtons';
import { Button } from './components/ui/button';
import { translations, getText, Language, PersonType } from './lib/translations';
import { Clock, Bell, User, Heart } from 'lucide-react';
import { Alert, AlertDescription, AlertTitle } from './components/ui/alert';

type ConversationStage = 
  | 'language-select'
  | 'person-select'
  | 'greeting'
  | 'health-sleep'
  | 'health-water'
  | 'health-medicine'
  | 'mood-check'
  | 'activity'
  | 'safety-door'
  | 'safety-gas'
  | 'night-medicine'
  | 'sleep-ready'
  | 'complete';

interface Message {
  text: string;
  isBot: boolean;
  timestamp: Date;
}

export default function App() {
  const [language, setLanguage] = useState<Language | null>(null);
  const [person, setPerson] = useState<PersonType>(null);
  const [stage, setStage] = useState<ConversationStage>('language-select');
  const [messages, setMessages] = useState<Message[]>([]);
  const [waitingForResponse, setWaitingForResponse] = useState(false);
  const [showFamilyAlert, setShowFamilyAlert] = useState(false);
  const [currentOptions, setCurrentOptions] = useState<string[]>([]);
  
  const timeoutRef = useRef<NodeJS.Timeout | null>(null);
  const reminderCountRef = useRef(0);
  const messagesEndRef = useRef<HTMLDivElement>(null);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  const addMessage = (text: string, isBot: boolean) => {
    setMessages(prev => [...prev, { text, isBot, timestamp: new Date() }]);
  };

  const clearTimeout = () => {
    if (timeoutRef.current) {
      window.clearTimeout(timeoutRef.current);
      timeoutRef.current = null;
    }
  };

  const startResponseTimer = (stage: ConversationStage) => {
    clearTimeout();
    reminderCountRef.current = 0;
    setWaitingForResponse(true);
    
    const scheduleReminder = () => {
      reminderCountRef.current += 1;
      
      if (reminderCountRef.current === 1) {
        // 2 minutes
        timeoutRef.current = window.setTimeout(() => {
          if (language) {
            addMessage(getText('areYouThere', language), true);
            scheduleReminder();
          }
        }, 120000); // 2 min
      } else if (reminderCountRef.current === 2) {
        // 5 minutes total (3 more minutes)
        timeoutRef.current = window.setTimeout(() => {
          if (language) {
            addMessage(getText('takeYourTime', language), true);
            scheduleReminder();
          }
        }, 180000); // 3 min
      } else if (reminderCountRef.current === 3) {
        // 10 minutes total (5 more minutes)
        timeoutRef.current = window.setTimeout(() => {
          if (language) {
            addMessage(getText('familyAlert', language), true);
            setShowFamilyAlert(true);
            setWaitingForResponse(false);
          }
        }, 300000); // 5 min
      }
    };
    
    scheduleReminder();
  };

  const handleResponse = (response: string, nextStage?: ConversationStage) => {
    clearTimeout();
    setWaitingForResponse(false);
    addMessage(response, false);
    
    if (nextStage) {
      setTimeout(() => {
        setStage(nextStage);
      }, 500);
    }
  };

  // Language selection
  useEffect(() => {
    if (stage === 'language-select') {
      setCurrentOptions([]);
    }
  }, [stage]);

  const handleLanguageSelect = (lang: Language) => {
    setLanguage(lang);
    setStage('person-select');
  };

  // Person selection
  useEffect(() => {
    if (stage === 'person-select' && language) {
      addMessage(getText('initialQuestion', language), true);
      setCurrentOptions([
        getText('grandpa', language),
        getText('grandma', language)
      ]);
      startResponseTimer('person-select');
    }
  }, [stage, language]);

  const handlePersonSelect = (selectedPerson: 'grandpa' | 'grandma') => {
    if (!language) return;
    
    clearTimeout();
    setPerson(selectedPerson);
    addMessage(getText(selectedPerson, language), false);
    
    setTimeout(() => {
      const greetingKey = selectedPerson === 'grandpa' ? 'greetingGrandpa' : 'greetingGrandma';
      addMessage(getText(greetingKey, language), true);
      
      setTimeout(() => {
        setStage('health-sleep');
      }, 1000);
    }, 500);
  };

  // Health Check - Sleep
  useEffect(() => {
    if (stage === 'health-sleep' && language) {
      setTimeout(() => {
        addMessage(getText('sleepQuestion', language), true);
        setCurrentOptions([
          getText('yes', language),
          getText('no', language)
        ]);
        startResponseTimer('health-sleep');
      }, 500);
    }
  }, [stage, language]);

  const handleSleepResponse = (response: string) => {
    if (!language) return;
    
    const yesText = getText('yes', language);
    const isYes = response === yesText;
    
    handleResponse(response);
    
    setTimeout(() => {
      const responseKey = isYes ? 'sleepYes' : 'sleepNo';
      addMessage(getText(responseKey, language, person), true);
      
      setTimeout(() => {
        setStage('health-water');
      }, 1000);
    }, 500);
  };

  // Health Check - Water
  useEffect(() => {
    if (stage === 'health-water' && language) {
      setTimeout(() => {
        addMessage(getText('waterQuestion', language), true);
        setCurrentOptions([
          getText('yes', language),
          getText('no', language)
        ]);
        startResponseTimer('health-water');
      }, 500);
    }
  }, [stage, language]);

  const handleWaterResponse = (response: string) => {
    if (!language) return;
    
    const yesText = getText('yes', language);
    const isYes = response === yesText;
    
    handleResponse(response);
    
    setTimeout(() => {
      const responseKey = isYes ? 'waterYes' : 'waterNo';
      addMessage(getText(responseKey, language, person), true);
      
      setTimeout(() => {
        setStage('health-medicine');
      }, 1000);
    }, 500);
  };

  // Health Check - Medicine
  useEffect(() => {
    if (stage === 'health-medicine' && language) {
      setTimeout(() => {
        addMessage(getText('medicineQuestion', language), true);
        setCurrentOptions([
          getText('yes', language),
          getText('no', language),
          getText('forgot', language)
        ]);
        startResponseTimer('health-medicine');
      }, 500);
    }
  }, [stage, language]);

  const handleMedicineResponse = (response: string) => {
    if (!language) return;
    
    const yesText = getText('yes', language);
    const forgotText = getText('forgot', language);
    
    handleResponse(response);
    
    setTimeout(() => {
      if (response === yesText) {
        addMessage(getText('medicineYes', language, person), true);
      } else if (response === forgotText) {
        addMessage(getText('medicineForgot', language), true);
      } else {
        addMessage(getText('medicineNo', language), true);
      }
      
      setTimeout(() => {
        setStage('mood-check');
      }, 1000);
    }, 500);
  };

  // Mood Check
  useEffect(() => {
    if (stage === 'mood-check' && language) {
      setTimeout(() => {
        addMessage(getText('moodQuestion', language), true);
        setCurrentOptions([
          getText('happy', language),
          getText('low', language),
          getText('tired', language)
        ]);
        startResponseTimer('mood-check');
      }, 500);
    }
  }, [stage, language]);

  const handleMoodResponse = (response: string) => {
    if (!language) return;
    
    const happyText = getText('happy', language);
    const lowText = getText('low', language);
    const tiredText = getText('tired', language);
    
    handleResponse(response);
    
    setTimeout(() => {
      let responseKey: 'moodHappy' | 'moodLow' | 'moodTired' = 'moodHappy';
      if (response === lowText) responseKey = 'moodLow';
      else if (response === tiredText) responseKey = 'moodTired';
      
      addMessage(getText(responseKey, language), true);
      
      setTimeout(() => {
        setStage('activity');
      }, 1000);
    }, 500);
  };

  // Activity - Show a joke or story
  useEffect(() => {
    if (stage === 'activity' && language && person) {
      setTimeout(() => {
        // Show a joke
        const jokeKey = person === 'grandpa' ? 'jokeGrandpa' : 'jokeGrandma';
        addMessage(getText(jokeKey, language), true);
        
        setTimeout(() => {
          setCurrentOptions([
            getText('yes', language),
            getText('no', language)
          ]);
          startResponseTimer('activity');
        }, 2000);
      }, 500);
    }
  }, [stage, language, person]);

  const handleActivityResponse = (response: string) => {
    if (!language) return;
    
    const yesText = getText('yes', language);
    
    handleResponse(response);
    
    setTimeout(() => {
      const responseKey = response === yesText ? 'hahaGlad' : 'maybeNextTime';
      addMessage(getText(responseKey, language), true);
      
      setTimeout(() => {
        setStage('safety-door');
      }, 1000);
    }, 500);
  };

  // Safety - Door
  useEffect(() => {
    if (stage === 'safety-door' && language) {
      setTimeout(() => {
        addMessage(getText('lockDoorQuestion', language), true);
        setCurrentOptions([
          getText('yes', language),
          getText('no', language)
        ]);
        startResponseTimer('safety-door');
      }, 500);
    }
  }, [stage, language]);

  const handleDoorResponse = (response: string) => {
    if (!language) return;
    
    const yesText = getText('yes', language);
    
    handleResponse(response);
    
    setTimeout(() => {
      if (response === yesText) {
        addMessage(getText('medicineYes', language, person), true);
      } else {
        addMessage(getText('lockDoorNo', language), true);
      }
      
      setTimeout(() => {
        setStage('safety-gas');
      }, 1000);
    }, 500);
  };

  // Safety - Gas
  useEffect(() => {
    if (stage === 'safety-gas' && language) {
      setTimeout(() => {
        addMessage(getText('gasQuestion', language), true);
        setCurrentOptions([
          getText('yes', language),
          getText('no', language)
        ]);
        startResponseTimer('safety-gas');
      }, 500);
    }
  }, [stage, language]);

  const handleGasResponse = (response: string) => {
    if (!language) return;
    
    const yesText = getText('yes', language);
    
    handleResponse(response);
    
    setTimeout(() => {
      if (response === yesText) {
        addMessage(getText('medicineYes', language, person), true);
      } else {
        addMessage(getText('gasNo', language), true);
      }
      
      setTimeout(() => {
        setStage('night-medicine');
      }, 1000);
    }, 500);
  };

  // Night Medicine
  useEffect(() => {
    if (stage === 'night-medicine' && language) {
      setTimeout(() => {
        addMessage(getText('nightMedicineQuestion', language), true);
        setCurrentOptions([
          getText('yes', language),
          getText('no', language)
        ]);
        startResponseTimer('night-medicine');
      }, 500);
    }
  }, [stage, language]);

  const handleNightMedicineResponse = (response: string) => {
    if (!language) return;
    
    const yesText = getText('yes', language);
    
    handleResponse(response);
    
    setTimeout(() => {
      if (response === yesText) {
        addMessage(getText('medicineYes', language, person), true);
      } else {
        addMessage(getText('nightMedicineNo', language), true);
      }
      
      setTimeout(() => {
        setStage('sleep-ready');
      }, 1000);
    }, 500);
  };

  // Sleep Ready
  useEffect(() => {
    if (stage === 'sleep-ready' && language) {
      setTimeout(() => {
        addMessage(getText('sleepReadyQuestion', language), true);
        setCurrentOptions([
          getText('yes', language),
          getText('no', language)
        ]);
        startResponseTimer('sleep-ready');
      }, 500);
    }
  }, [stage, language]);

  const handleSleepReadyResponse = (response: string) => {
    if (!language) return;
    
    const yesText = getText('yes', language);
    
    handleResponse(response);
    
    setTimeout(() => {
      if (response === yesText) {
        addMessage(getText('goodNight', language), true);
      } else {
        addMessage(getText('okayTakeYourTime', language), true);
      }
      
      setTimeout(() => {
        addMessage(getText('closingMessage', language, person), true);
        setStage('complete');
      }, 1000);
    }, 500);
  };

  const languages: { code: Language; name: string; flag: string }[] = [
    { code: 'english', name: 'English', flag: 'ğŸ‡¬ğŸ‡§' },
    { code: 'tamil', name: 'à®¤à®®à®¿à®´à¯', flag: 'ğŸ‡®ğŸ‡³' },
    { code: 'hindi', name: 'à¤¹à¤¿à¤‚à¤¦à¥€', flag: 'ğŸ‡®ğŸ‡³' },
    { code: 'telugu', name: 'à°¤à±†à°²à±à°—à±', flag: 'ğŸ‡®ğŸ‡³' },
    { code: 'kannada', name: 'à²•à²¨à³à²¨à²¡', flag: 'ğŸ‡®ğŸ‡³' },
    { code: 'malayalam', name: 'à´®à´²à´¯à´¾à´³à´‚', flag: 'ğŸ‡®ğŸ‡³' }
  ];

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 flex items-center justify-center p-4">
      <div className="w-full max-w-2xl">
        {/* Header */}
        <div className="bg-white rounded-t-3xl shadow-lg p-6 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center">
              <Heart className="w-6 h-6 text-white" />
            </div>
            <div>
              <h1 className="text-gray-900">Care Companion</h1>
              <p className="text-sm text-gray-500">
                {person && language ? getText(person, language) : 'Your daily check-in'}
              </p>
            </div>
          </div>
          <User className="w-6 h-6 text-gray-400" />
        </div>

        {/* Main Content */}
        <div className="bg-white shadow-lg" style={{ minHeight: '500px', maxHeight: '600px' }}>
          {stage === 'language-select' ? (
            <div className="p-8 flex flex-col items-center justify-center" style={{ minHeight: '500px' }}>
              <h2 className="text-center text-gray-900 mb-8">Select Your Language</h2>
              <div className="grid grid-cols-2 gap-4 w-full max-w-md">
                {languages.map((lang) => (
                  <Button
                    key={lang.code}
                    onClick={() => handleLanguageSelect(lang.code)}
                    className="h-20 text-lg rounded-2xl bg-gradient-to-br from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600"
                  >
                    <span className="text-2xl mr-2">{lang.flag}</span>
                    {lang.name}
                  </Button>
                ))}
              </div>
            </div>
          ) : (
            <div className="flex flex-col" style={{ height: '500px' }}>
              {/* Messages Area */}
              <div className="flex-1 overflow-y-auto p-6">
                {messages.map((msg, index) => (
                  <ConversationBubble
                    key={index}
                    message={msg.text}
                    isBot={msg.isBot}
                    timestamp={msg.timestamp}
                  />
                ))}
                <div ref={messagesEndRef} />
              </div>

              {/* Response Area */}
              <div className="border-t border-gray-200 p-4 bg-gray-50">
                {currentOptions.length > 0 && (
                  <ResponseButtons
                    options={currentOptions}
                    onSelect={(option) => {
                      setCurrentOptions([]);
                      
                      // Route to appropriate handler based on stage
                      if (stage === 'person-select') {
                        const personType = option === getText('grandpa', language!) ? 'grandpa' : 'grandma';
                        handlePersonSelect(personType);
                      } else if (stage === 'health-sleep') {
                        handleSleepResponse(option);
                      } else if (stage === 'health-water') {
                        handleWaterResponse(option);
                      } else if (stage === 'health-medicine') {
                        handleMedicineResponse(option);
                      } else if (stage === 'mood-check') {
                        handleMoodResponse(option);
                      } else if (stage === 'activity') {
                        handleActivityResponse(option);
                      } else if (stage === 'safety-door') {
                        handleDoorResponse(option);
                      } else if (stage === 'safety-gas') {
                        handleGasResponse(option);
                      } else if (stage === 'night-medicine') {
                        handleNightMedicineResponse(option);
                      } else if (stage === 'sleep-ready') {
                        handleSleepReadyResponse(option);
                      }
                    }}
                    disabled={waitingForResponse && currentOptions.length === 0}
                  />
                )}
                
                {stage === 'complete' && (
                  <div className="text-center">
                    <Button
                      onClick={() => {
                        setMessages([]);
                        setStage('language-select');
                        setLanguage(null);
                        setPerson(null);
                        setShowFamilyAlert(false);
                      }}
                      className="rounded-full bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600"
                    >
                      Start New Session
                    </Button>
                  </div>
                )}
              </div>
            </div>
          )}
        </div>

        {/* Footer */}
        <div className="bg-white rounded-b-3xl shadow-lg p-4 flex items-center justify-center gap-4 text-sm text-gray-500">
          <Clock className="w-4 h-4" />
          <span>{new Date().toLocaleDateString()}</span>
        </div>

        {/* Family Alert */}
        {showFamilyAlert && language && (
          <Alert className="mt-4 border-red-500 bg-red-50">
            <Bell className="h-4 w-4 text-red-600" />
            <AlertTitle className="text-red-900">
              {getText('familyAlert', language)}
            </AlertTitle>
            <AlertDescription className="text-red-800">
              No response received for 10 minutes. Family members have been notified.
            </AlertDescription>
          </Alert>
        )}
      </div>
    </div>
  );
}
